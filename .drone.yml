---
kind: pipeline
type: docker
name: coding-standard-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: coding-standard
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phpstan-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: phpstan
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-phpstan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phan-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: phan
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phan-php7.2

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: phan
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phan-php7.3

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: phan
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

---
kind: pipeline
type: docker
name: phpunit-scality-php7.1-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 scality:8000
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/scality.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - php occ s3:create-bucket owncloud --accept-warning
  - for I in $(seq 1 9); do php ./occ s3:create-bucket  owncloud$I --accept-warning; done

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-unit

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-scality-php7.2-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 scality:8000
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/scality.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - php occ s3:create-bucket owncloud --accept-warning
  - for I in $(seq 1 9); do php ./occ s3:create-bucket  owncloud$I --accept-warning; done

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-unit

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-scality-php7.3-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 scality:8000
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/scality.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - php occ s3:create-bucket owncloud --accept-warning
  - for I in $(seq 1 9); do php ./occ s3:create-bucket  owncloud$I --accept-warning; done

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-unit

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-scality-multibucket-php7.1-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 scality:8000
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/scality.multibucket.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - php occ s3:create-bucket owncloud --accept-warning
  - for I in $(seq 1 9); do php ./occ s3:create-bucket  owncloud$I --accept-warning; done

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-unit

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-scality-multibucket-php7.2-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 scality:8000
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/scality.multibucket.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - php occ s3:create-bucket owncloud --accept-warning
  - for I in $(seq 1 9); do php ./occ s3:create-bucket  owncloud$I --accept-warning; done

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-unit

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-scality-multibucket-php7.3-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-scality
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 scality:8000
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/scality.multibucket.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - php occ s3:create-bucket owncloud --accept-warning
  - for I in $(seq 1 9); do php ./occ s3:create-bucket  owncloud$I --accept-warning; done

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-unit

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-ceph-php7.1-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-unit

services:
- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-ceph-php7.2-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.2
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.2
  commands:
  - make test-php-unit

services:
- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: phpunit-ceph-php7.3-sqlite

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: server/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: sqlite
    db_name: owncloud
    db_password: owncloud
    db_type: sqlite
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.3
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: phpunit-tests
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-unit

services:
- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-1-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 1
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-2-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 2
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-3-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 3
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-4-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 4
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-5-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 5
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-6-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 6
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-7-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 7
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-8-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 8
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-9-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 9
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-10-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 10
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-11-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 11
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-12-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 12
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-13-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 13
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-14-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 14
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-15-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 15
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-16-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 16
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-17-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 17
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-18-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 18
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-19-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 19
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-20-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 20
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-21-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 21
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-22-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 22
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-23-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 23
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-24-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 24
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-25-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 25
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-26-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 26
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-27-master-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 27
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-1-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 1
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-2-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 2
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-3-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 3
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-4-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 4
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-5-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 5
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-6-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 6
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-7-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 7
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-8-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 8
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-9-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 9
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-10-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 10
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-11-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 11
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-12-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 12
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-13-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 13
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-14-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 14
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-15-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 15
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-16-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 16
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-17-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 17
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-18-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 18
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-19-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 19
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-20-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 20
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-21-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 21
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-22-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 22
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-23-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 23
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-24-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 24
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-25-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 25
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-26-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 26
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: webUIall-27-27-latest-chrome-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-webui
  environment:
    BROWSER: chrome
    DIVIDE_INTO_NUM_PARTS: 27
    MAILHOG_HOST: email
    OC_TEST_ON_OBJECTSTORE: 1
    PLATFORM: Linux
    RUN_PART: 27
    S3_TYPE: ceph
    SELENIUM_HOST: selenium
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: selenium
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

- name: email
  pull: always
  image: mailhog/mailhog

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-1-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 1
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-2-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 2
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-3-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 3
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-4-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 4
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-5-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 5
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-6-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 6
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-7-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 7
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-8-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 8
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-9-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 9
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-10-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 10
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-11-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 11
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-12-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 12
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-13-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 13
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-14-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 14
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-15-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 15
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-16-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 16
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-17-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 17
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-18-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 18
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-19-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 19
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-20-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 20
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-21-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 21
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-22-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 22
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-23-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 23
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-24-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 24
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-25-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 25
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-26-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 26
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-27-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 27
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-28-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 28
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-29-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 29
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-30-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 30
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-31-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 31
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-32-master-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: daily-master-qa

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: daily-master-qa

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 32
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/pull/**
  - refs/tags/**
  - refs/heads/master

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-1-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 1
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-2-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 2
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-3-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 3
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-4-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 4
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-5-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 5
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-6-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 6
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-7-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 7
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-8-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 8
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-9-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 9
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-10-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 10
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-11-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 11
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-12-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 12
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-13-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 13
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-14-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 14
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-15-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 15
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-16-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 16
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-17-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 17
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-18-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 18
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-19-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 19
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-20-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 20
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-21-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 21
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-22-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 22
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-23-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 23
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-24-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 24
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-25-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 25
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-26-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 26
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-27-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 27
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-28-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 28
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-29-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 29
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-30-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 30
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-31-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 31
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: apiAll-32-32-latest-mariadb10.2-php7.1

platform:
  os: linux
  arch: amd64

workspace:
  base: /var/www/owncloud
  path: testrunner/apps/files_primary_s3

steps:
- name: install-core
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/server
    db_host: mariadb
    db_name: owncloud
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    exclude: apps/files_primary_s3
    version: latest

- name: install-testrunner
  pull: always
  image: owncloudci/php:7.1
  commands:
  - mkdir /tmp/testrunner
  - git clone -b master --depth=1 https://github.com/owncloud/core.git /tmp/testrunner
  - rsync -aIX /tmp/testrunner /var/www/owncloud
  - cp -r /var/www/owncloud/testrunner/apps/files_primary_s3 /var/www/owncloud/server/apps/

- name: install-federated
  pull: always
  image: owncloudci/core
  settings:
    core_path: /var/www/owncloud/federated
    db_host: mariadb-federated
    db_name: owncloud-federated
    db_password: owncloud
    db_type: mysql
    db_username: owncloud
    version: latest

- name: configure-federation
  pull: always
  image: owncloudci/php:7.1
  commands:
  - echo "export TEST_SERVER_FED_URL=http://federated" > /var/www/owncloud/saved-settings.sh
  - cd /var/www/owncloud/federated
  - php occ a:l
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=federated
  - php occ log:manage --level 2
  - php occ config:list

- name: owncloud-log-federated
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/federated/data/owncloud.log

- name: install-app-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - composer install

- name: setup-server-files_primary_s3
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /var/www/owncloud/server
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:e testing
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server
  - php occ log:manage --level 2

- name: owncloud-log-server
  pull: always
  image: owncloud/ubuntu:18.04
  detach: true
  commands:
  - tail -f /var/www/owncloud/server/data/owncloud.log

- name: setup-ceph
  pull: always
  image: owncloudci/php:7.1
  commands:
  - wait-for-it -t 600 ceph:80
  - cd /var/www/owncloud/server/apps/files_primary_s3
  - cp tests/drone/ceph.config.php /var/www/owncloud/server/config
  - cd /var/www/owncloud/server
  - ./apps/files_primary_s3/tests/drone/create-bucket.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown -R www-data /var/www/owncloud/server
  - wait-for-it -t 600 server:80
  - chown -R www-data /var/www/owncloud/federated
  - wait-for-it -t 600 federated:80

- name: acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /var/www/owncloud/saved-settings.sh
  - . /var/www/owncloud/saved-settings.sh
  - make test-acceptance-core-api
  environment:
    DIVIDE_INTO_NUM_PARTS: 32
    OC_TEST_ON_OBJECTSTORE: 1
    RUN_PART: 32
    S3_TYPE: ceph
    TEST_SERVER_URL: http://server

services:
- name: mariadb
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: ceph
  pull: always
  image: owncloudci/ceph:tag-build-master-jewel-ubuntu-16.04
  environment:
    CEPH_DEMO_ACCESS_KEY: owncloud123456
    CEPH_DEMO_SECRET_KEY: secret123456
    CEPH_DEMO_UID: owncloud
    NETWORK_AUTO_DETECT: 4
    RGW_NAME: ceph

- name: server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/server

- name: federated
  pull: always
  image: owncloudci/php:7.1
  commands:
  - /usr/local/bin/apachectl -e debug -D FOREGROUND
  environment:
    APACHE_WEBROOT: /var/www/owncloud/federated

- name: mariadb-federated
  pull: always
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud-federated
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  cron:
  - nightly

depends_on:
- coding-standard-php7.1
- phpstan-php7.2
- phan-php7.1
- phan-php7.2
- phan-php7.3

---
kind: pipeline
type: docker
name: chat-notifications

platform:
  os: linux
  arch: amd64

clone:
  disable: true

steps:
- name: notify-rocketchat
  pull: always
  image: plugins/slack:1
  settings:
    channel: builds
    webhook:
      from_secret: private_rocketchat

trigger:
  ref:
  - refs/tags/**
  - refs/heads/master
  status:
  - success
  - failure

depends_on:
- phpunit-scality-php7.1-sqlite
- phpunit-scality-php7.2-sqlite
- phpunit-scality-php7.3-sqlite
- phpunit-scality-multibucket-php7.1-sqlite
- phpunit-scality-multibucket-php7.2-sqlite
- phpunit-scality-multibucket-php7.3-sqlite
- phpunit-ceph-php7.1-sqlite
- phpunit-ceph-php7.2-sqlite
- phpunit-ceph-php7.3-sqlite
- webUIall-27-1-master-chrome-mariadb10.2-php7.1
- webUIall-27-2-master-chrome-mariadb10.2-php7.1
- webUIall-27-3-master-chrome-mariadb10.2-php7.1
- webUIall-27-4-master-chrome-mariadb10.2-php7.1
- webUIall-27-5-master-chrome-mariadb10.2-php7.1
- webUIall-27-6-master-chrome-mariadb10.2-php7.1
- webUIall-27-7-master-chrome-mariadb10.2-php7.1
- webUIall-27-8-master-chrome-mariadb10.2-php7.1
- webUIall-27-9-master-chrome-mariadb10.2-php7.1
- webUIall-27-10-master-chrome-mariadb10.2-php7.1
- webUIall-27-11-master-chrome-mariadb10.2-php7.1
- webUIall-27-12-master-chrome-mariadb10.2-php7.1
- webUIall-27-13-master-chrome-mariadb10.2-php7.1
- webUIall-27-14-master-chrome-mariadb10.2-php7.1
- webUIall-27-15-master-chrome-mariadb10.2-php7.1
- webUIall-27-16-master-chrome-mariadb10.2-php7.1
- webUIall-27-17-master-chrome-mariadb10.2-php7.1
- webUIall-27-18-master-chrome-mariadb10.2-php7.1
- webUIall-27-19-master-chrome-mariadb10.2-php7.1
- webUIall-27-20-master-chrome-mariadb10.2-php7.1
- webUIall-27-21-master-chrome-mariadb10.2-php7.1
- webUIall-27-22-master-chrome-mariadb10.2-php7.1
- webUIall-27-23-master-chrome-mariadb10.2-php7.1
- webUIall-27-24-master-chrome-mariadb10.2-php7.1
- webUIall-27-25-master-chrome-mariadb10.2-php7.1
- webUIall-27-26-master-chrome-mariadb10.2-php7.1
- webUIall-27-27-master-chrome-mariadb10.2-php7.1
- webUIall-27-1-latest-chrome-mariadb10.2-php7.1
- webUIall-27-2-latest-chrome-mariadb10.2-php7.1
- webUIall-27-3-latest-chrome-mariadb10.2-php7.1
- webUIall-27-4-latest-chrome-mariadb10.2-php7.1
- webUIall-27-5-latest-chrome-mariadb10.2-php7.1
- webUIall-27-6-latest-chrome-mariadb10.2-php7.1
- webUIall-27-7-latest-chrome-mariadb10.2-php7.1
- webUIall-27-8-latest-chrome-mariadb10.2-php7.1
- webUIall-27-9-latest-chrome-mariadb10.2-php7.1
- webUIall-27-10-latest-chrome-mariadb10.2-php7.1
- webUIall-27-11-latest-chrome-mariadb10.2-php7.1
- webUIall-27-12-latest-chrome-mariadb10.2-php7.1
- webUIall-27-13-latest-chrome-mariadb10.2-php7.1
- webUIall-27-14-latest-chrome-mariadb10.2-php7.1
- webUIall-27-15-latest-chrome-mariadb10.2-php7.1
- webUIall-27-16-latest-chrome-mariadb10.2-php7.1
- webUIall-27-17-latest-chrome-mariadb10.2-php7.1
- webUIall-27-18-latest-chrome-mariadb10.2-php7.1
- webUIall-27-19-latest-chrome-mariadb10.2-php7.1
- webUIall-27-20-latest-chrome-mariadb10.2-php7.1
- webUIall-27-21-latest-chrome-mariadb10.2-php7.1
- webUIall-27-22-latest-chrome-mariadb10.2-php7.1
- webUIall-27-23-latest-chrome-mariadb10.2-php7.1
- webUIall-27-24-latest-chrome-mariadb10.2-php7.1
- webUIall-27-25-latest-chrome-mariadb10.2-php7.1
- webUIall-27-26-latest-chrome-mariadb10.2-php7.1
- webUIall-27-27-latest-chrome-mariadb10.2-php7.1
- apiAll-32-1-master-mariadb10.2-php7.1
- apiAll-32-2-master-mariadb10.2-php7.1
- apiAll-32-3-master-mariadb10.2-php7.1
- apiAll-32-4-master-mariadb10.2-php7.1
- apiAll-32-5-master-mariadb10.2-php7.1
- apiAll-32-6-master-mariadb10.2-php7.1
- apiAll-32-7-master-mariadb10.2-php7.1
- apiAll-32-8-master-mariadb10.2-php7.1
- apiAll-32-9-master-mariadb10.2-php7.1
- apiAll-32-10-master-mariadb10.2-php7.1
- apiAll-32-11-master-mariadb10.2-php7.1
- apiAll-32-12-master-mariadb10.2-php7.1
- apiAll-32-13-master-mariadb10.2-php7.1
- apiAll-32-14-master-mariadb10.2-php7.1
- apiAll-32-15-master-mariadb10.2-php7.1
- apiAll-32-16-master-mariadb10.2-php7.1
- apiAll-32-17-master-mariadb10.2-php7.1
- apiAll-32-18-master-mariadb10.2-php7.1
- apiAll-32-19-master-mariadb10.2-php7.1
- apiAll-32-20-master-mariadb10.2-php7.1
- apiAll-32-21-master-mariadb10.2-php7.1
- apiAll-32-22-master-mariadb10.2-php7.1
- apiAll-32-23-master-mariadb10.2-php7.1
- apiAll-32-24-master-mariadb10.2-php7.1
- apiAll-32-25-master-mariadb10.2-php7.1
- apiAll-32-26-master-mariadb10.2-php7.1
- apiAll-32-27-master-mariadb10.2-php7.1
- apiAll-32-28-master-mariadb10.2-php7.1
- apiAll-32-29-master-mariadb10.2-php7.1
- apiAll-32-30-master-mariadb10.2-php7.1
- apiAll-32-31-master-mariadb10.2-php7.1
- apiAll-32-32-master-mariadb10.2-php7.1
- apiAll-32-1-latest-mariadb10.2-php7.1
- apiAll-32-2-latest-mariadb10.2-php7.1
- apiAll-32-3-latest-mariadb10.2-php7.1
- apiAll-32-4-latest-mariadb10.2-php7.1
- apiAll-32-5-latest-mariadb10.2-php7.1
- apiAll-32-6-latest-mariadb10.2-php7.1
- apiAll-32-7-latest-mariadb10.2-php7.1
- apiAll-32-8-latest-mariadb10.2-php7.1
- apiAll-32-9-latest-mariadb10.2-php7.1
- apiAll-32-10-latest-mariadb10.2-php7.1
- apiAll-32-11-latest-mariadb10.2-php7.1
- apiAll-32-12-latest-mariadb10.2-php7.1
- apiAll-32-13-latest-mariadb10.2-php7.1
- apiAll-32-14-latest-mariadb10.2-php7.1
- apiAll-32-15-latest-mariadb10.2-php7.1
- apiAll-32-16-latest-mariadb10.2-php7.1
- apiAll-32-17-latest-mariadb10.2-php7.1
- apiAll-32-18-latest-mariadb10.2-php7.1
- apiAll-32-19-latest-mariadb10.2-php7.1
- apiAll-32-20-latest-mariadb10.2-php7.1
- apiAll-32-21-latest-mariadb10.2-php7.1
- apiAll-32-22-latest-mariadb10.2-php7.1
- apiAll-32-23-latest-mariadb10.2-php7.1
- apiAll-32-24-latest-mariadb10.2-php7.1
- apiAll-32-25-latest-mariadb10.2-php7.1
- apiAll-32-26-latest-mariadb10.2-php7.1
- apiAll-32-27-latest-mariadb10.2-php7.1
- apiAll-32-28-latest-mariadb10.2-php7.1
- apiAll-32-29-latest-mariadb10.2-php7.1
- apiAll-32-30-latest-mariadb10.2-php7.1
- apiAll-32-31-latest-mariadb10.2-php7.1
- apiAll-32-32-latest-mariadb10.2-php7.1

...
